<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Civic Sathi - Login</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .notification { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); padding: 12px 24px; border-radius: 8px; color: white; opacity: 0; visibility: hidden; transition: all 0.3s; z-index: 1000; }
        .notification.show { opacity: 1; visibility: visible; transform: translate(-50%, -10px); }
        .notification.success { background-color: #28a745; }
        .notification.error { background-color: #dc3545; }
        #loader { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255,255,255,0.7); z-index: 2000; justify-content: center; align-items: center; }
        .spinner { border: 5px solid #f3f3f3; border-top: 5px solid #6366f1; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen bg-gray-100">
    <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-sm">
        <h2 class="text-3xl font-bold mb-6 text-gray-800 text-center">Welcome Back</h2>
        <form id="loginForm" class="space-y-4">
            <div>
                <label for="loginUserId" class="block text-sm font-medium text-gray-700">User ID</label>
                <input type="text" id="loginUserId" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <div>
                <label for="loginPassword" class="block text-sm font-medium text-gray-700">Password</label>
                <input type="password" id="loginPassword" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                Log In
            </button>
        </form>

        <div class="mt-4 text-center text-sm space-y-2">
            <a href="forgot-password.html" class="font-medium text-indigo-600 hover:text-indigo-500 block">Forgot User ID / Password?</a>
            <p class="text-gray-600 pt-2">No account? <a href="register.html" class="font-medium text-indigo-600 hover:text-indigo-500">Register here</a></p>
        </div>
        </div>

    <div id="loader"><div class="spinner"></div></div>
    <div id="notification" class="notification"></div>

    <script>
        const API_URL = "";
        const loginForm = document.getElementById("loginForm");
        const loginUserIdInput = document.getElementById("loginUserId");
        const loginPasswordInput = document.getElementById("loginPassword");
        const loader = document.getElementById("loader");
        const notification = document.getElementById("notification");

        function showNotification(message, type = 'success') {
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            setTimeout(() => { notification.classList.remove('show'); }, 3000);
        }

        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const userId = params.get('user_id');
            const isVerified = params.get('verified');

            if (userId) {
                loginUserIdInput.value = userId;
            }

            if (isVerified) {
                showNotification('Email verified successfully! You can now log in.', 'success');
            }
        });

        loginForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            loader.style.display = 'flex';
            try {
                const res = await fetch(`${API_URL}/login`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        user_id: loginUserIdInput.value.trim(),
                        password: loginPasswordInput.value
                    })
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || 'Login failed');
                
                localStorage.setItem('token', data.token);
                showNotification(data.message || 'Login successful', 'success');

                const urlParams = new URLSearchParams(window.location.search);
                const next = urlParams.get('next');
                
                if (next) {
                    const isSafeRedirect = next.startsWith('/') && !next.startsWith('//') && !next.includes(':');
                    if (isSafeRedirect) {
                         window.location.href = next;
                    } else {
                        window.location.href = 'account.html';
                    }
                } else {
                    window.location.href = 'account.html';
                }

            } catch (error) {
                showNotification(error.message, 'error');
            } finally {
                loader.style.display = 'none';
            }
        });
    </script>
</body>
</html>